\begin{lstlisting}[caption=Kode til at hente bruger information, label=AD-GETINFO]

// Create directory search filter based on email
var dsFilter = "(mail=" + username + ")";

// Use username and password to create new directory entry
var de = new DirectoryEntry
   (
      "LDAP://" + Configuration.LDAPServer, 
      username.Substring(0, username.IndexOf("@")), 
      password
   );

// Use directory entry and filter to create a searcher for the directory
var ds = new DirectorySearcher(de)
   {
      Filter = dsFilter
   };

SearchResult result = null;

// Try to find an element in the directory with the users email
try
{
   result = ds.FindOne();
}
catch (COMException)
{
   // If communication exception, return -1
   return new Person { ID = -1 };
}


// Return null if no user is found in the AD (unlikely, but possible)
if (result == null)
{
   return null;
}


// Return person with empty mail, name and token 
// if found user  has no ituAffiliation
if (!result.Properties.Contains("ituAffiliation") 
    || !result.Properties.Contains("mail"))
{
   return new Person 
	{ Email = string.Empty, 
	   Name = string.Empty, 
	   Token = string.Empty 
	};
}


// If there exists any user in the database with the same email as result,
// generate token for the person, save changes and return the found person
if (All.Any(p => p.Email.Equals(result.Properties["mail"][0].ToString())))
{
   var person = All.First(
		p 
		=> 
		p.Email.Equals(result.Properties["mail"][0].ToString()
		));
   person.Token = GenerateToken();

   BookITContext.Db.SaveChanges();

   return person;
}
else
{
   // If no such user exists, create new user in database 
   // with email and name equal to result
   // then generate token, add the person to the database, 
   // save changes and return the new person
   // from the database
   var person = new Person
         {
                  Email = result.Properties["mail"][0].ToString(),
                  Name = result.Properties["displayName"][0].ToString()
         };

         person.Roles.Add
	(
	   new Role() 
	    { RoleName = result.Properties["ituAffiliation"][0].ToString()}
	);
         person.Token = GenerateToken();

         BookITContext.Db.People.Add(person);
         BookITContext.Db.SaveChanges();

         return All.FirstOrDefault(p => p.Email.Equals(person.Email));
}
\end{lstlisting}